version: 2.1

# Define reusable commands
commands:
  restore-dotnet-cache:
    description: "Restore .NET NuGet packages cache"
    steps:
      - restore_cache:
          keys:
            - dotnet-packages-v1-{{ checksum "Directory.Packages.props" }}
            - dotnet-packages-v1-

  save-dotnet-cache:
    description: "Save .NET NuGet packages cache"
    steps:
      - save_cache:
          key: dotnet-packages-v1-{{ checksum "Directory.Packages.props" }}
          paths:
            - ~/.nuget/packages

# Define jobs
jobs:
  build-and-test:
    docker:
      - image: mcr.microsoft.com/dotnet/sdk:8.0
      - image: mysql:8.0
        environment:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: MigratingAssistantTest
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpassword

    resource_class: medium

    steps:
      - checkout

      # Restore NuGet packages from cache
      - restore-dotnet-cache

      # Restore dependencies
      - run:
          name: "Restore NuGet packages"
          command: |
            dotnet restore

      # Save NuGet cache
      - save-dotnet-cache

      # Build solution
      - run:
          name: "Build solution"
          command: |
            dotnet build --configuration Release --no-restore

      # Wait for MySQL to be ready
      - run:
          name: "Wait for MySQL"
          command: |
            apt-get update && apt-get install -y default-mysql-client netcat-openbsd
            for i in {1..30}; do
              if nc -z 127.0.0.1 3306; then
                echo "MySQL is ready!"
                break
              fi
              echo "Waiting for MySQL... (attempt $i/30)"
              sleep 2
            done
            # Verify connection
            mysql -h 127.0.0.1 -u root -ptestpassword -e "SELECT 1"

      # Run unit tests (Domain and Application)
      - run:
          name: "Run unit tests"
          command: |
            dotnet test tests/Domain.UnitTests/Domain.UnitTests.csproj \
              --configuration Release \
              --no-build \
              --logger "trx;LogFileName=domain-test-results.trx" \
              --collect:"XPlat Code Coverage" \
              -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

            dotnet test tests/Application.UnitTests/Application.UnitTests.csproj \
              --configuration Release \
              --no-build \
              --logger "trx;LogFileName=application-test-results.trx" \
              --collect:"XPlat Code Coverage" \
              -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      # Run integration tests with MySQL
      - run:
          name: "Run integration tests"
          environment:
            ConnectionStrings__DefaultConnection: "Server=127.0.0.1;Database=MigratingAssistantTest;Uid=testuser;Pwd=testpassword;"
            ASPNETCORE_ENVIRONMENT: "Testing"
          command: |
            dotnet test tests/Infrastructure.IntegrationTests/Infrastructure.IntegrationTests.csproj \
              --configuration Release \
              --no-build \
              --logger "trx;LogFileName=integration-test-results.trx" \
              --collect:"XPlat Code Coverage" \
              -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      # Run functional tests
      - run:
          name: "Run functional tests"
          environment:
            ConnectionStrings__DefaultConnection: "Server=127.0.0.1;Database=MigratingAssistantTest;Uid=testuser;Pwd=testpassword;"
            ASPNETCORE_ENVIRONMENT: "Testing"
            JwtSettings__Secret: "test-secret-key-at-least-32-characters-long-for-testing"
          command: |
            dotnet test tests/Application.FunctionalTests/Application.FunctionalTests.csproj \
              --configuration Release \
              --no-build \
              --logger "trx;LogFileName=functional-test-results.trx" \
              --collect:"XPlat Code Coverage" \
              -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      # Store test results
      - store_test_results:
          path: tests

      # Store artifacts (test results and coverage)
      - store_artifacts:
          path: tests/Domain.UnitTests/TestResults
          destination: test-results/domain

      - store_artifacts:
          path: tests/Application.UnitTests/TestResults
          destination: test-results/application

      - store_artifacts:
          path: tests/Infrastructure.IntegrationTests/TestResults
          destination: test-results/infrastructure

      - store_artifacts:
          path: tests/Application.FunctionalTests/TestResults
          destination: test-results/functional

  publish-artifacts:
    docker:
      - image: mcr.microsoft.com/dotnet/sdk:8.0

    resource_class: medium

    steps:
      - checkout

      # Restore NuGet packages from cache
      - restore-dotnet-cache

      # Restore dependencies
      - run:
          name: "Restore NuGet packages"
          command: |
            dotnet restore

      # Publish application
      - run:
          name: "Publish application"
          command: |
            dotnet publish src/Web/Web.csproj \
              --configuration Release \
              --output ./publish \
              --no-restore \
              /p:UseAppHost=false

      # Create deployment package
      - run:
          name: "Create deployment package"
          command: |
            cd publish
            tar -czf ../migratingassistant-api-${CIRCLE_SHA1}.tar.gz *
            cd ..
            echo "Package created: migratingassistant-api-${CIRCLE_SHA1}.tar.gz"
            ls -lh migratingassistant-api-${CIRCLE_SHA1}.tar.gz

      # Store published artifacts
      - store_artifacts:
          path: migratingassistant-api-${CIRCLE_SHA1}.tar.gz
          destination: artifacts/migratingassistant-api-${CIRCLE_SHA1}.tar.gz

      - persist_to_workspace:
          root: .
          paths:
            - publish
            - migratingassistant-api-*.tar.gz

  build-and-push-docker:
    docker:
      - image: cimg/base:current

    resource_class: medium

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true

      # Install doctl (Digital Ocean CLI)
      - run:
          name: "Install doctl"
          command: |
            cd ~
            wget https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
            tar xf doctl-1.104.0-linux-amd64.tar.gz
            sudo mv doctl /usr/local/bin
            doctl version

      # Authenticate with Digital Ocean Container Registry
      - run:
          name: "Authenticate with Digital Ocean Container Registry"
          command: |
            echo "Authenticating with Digital Ocean..."
            echo "Registry: registry.digitalocean.com/${DO_REGISTRY_NAME:-migratingassistant}"
            echo "Branch: ${CIRCLE_BRANCH}"

            if [ -z "$DO_ACCESS_TOKEN" ]; then
              echo "ERROR: DO_ACCESS_TOKEN environment variable is not set!"
              echo "Please add it to CircleCI Project Settings → Environment Variables"
              exit 1
            fi

            if [ -z "$DO_REGISTRY_NAME" ]; then
              echo "ERROR: DO_REGISTRY_NAME environment variable is not set!"
              echo "Please add it to CircleCI Project Settings → Environment Variables"
              echo "Value should be: migratingassistant"
              exit 1
            fi

            doctl auth init --access-token ${DO_ACCESS_TOKEN}
            doctl registry login

            echo "✓ Successfully authenticated with Digital Ocean Container Registry"
            echo "✓ Registry: registry.digitalocean.com/${DO_REGISTRY_NAME}"

      # Build Docker image
      - run:
          name: "Build Docker image"
          command: |
            echo "Building Docker image..."
            echo "Commit: ${CIRCLE_SHA1}"
            echo "Branch: ${CIRCLE_BRANCH}"

            docker build -t migratingassistant-api:${CIRCLE_SHA1} .
            docker tag migratingassistant-api:${CIRCLE_SHA1} migratingassistant-api:latest

            echo "✓ Docker image built successfully"

      # Tag for Digital Ocean Container Registry
      - run:
          name: "Tag image for DOCR"
          command: |
            REGISTRY_NAME="${DO_REGISTRY_NAME}"
            REGISTRY_URL="registry.digitalocean.com/${REGISTRY_NAME}"

            echo "Tagging images for Digital Ocean Container Registry..."
            echo "Registry: ${REGISTRY_URL}"
            echo "Repository: migratingassistant-api"
            echo ""

            docker tag migratingassistant-api:${CIRCLE_SHA1} ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_SHA1}
            docker tag migratingassistant-api:${CIRCLE_SHA1} ${REGISTRY_URL}/migratingassistant-api:latest
            docker tag migratingassistant-api:${CIRCLE_SHA1} ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_BRANCH}

            echo "✓ Images tagged:"
            echo "  - ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_SHA1}"
            echo "  - ${REGISTRY_URL}/migratingassistant-api:latest"
            echo "  - ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_BRANCH}"

      # Push to Digital Ocean Container Registry
      - run:
          name: "Push to Digital Ocean Container Registry"
          command: |
            REGISTRY_NAME="${DO_REGISTRY_NAME}"
            REGISTRY_URL="registry.digitalocean.com/${REGISTRY_NAME}"

            echo "Pushing images to Digital Ocean Container Registry..."
            echo "This may take a few minutes depending on image size..."
            echo ""

            echo "Pushing: ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_SHA1}"
            docker push ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_SHA1}

            echo "Pushing: ${REGISTRY_URL}/migratingassistant-api:latest"
            docker push ${REGISTRY_URL}/migratingassistant-api:latest

            echo "Pushing: ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_BRANCH}"
            docker push ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_BRANCH}

            echo ""
            echo "✓ All images pushed successfully!"
            echo ""
            echo "═══════════════════════════════════════════════════════"
            echo "Images available at:"
            echo "  ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_SHA1}"
            echo "  ${REGISTRY_URL}/migratingassistant-api:latest"
            echo "  ${REGISTRY_URL}/migratingassistant-api:${CIRCLE_BRANCH}"
            echo "═══════════════════════════════════════════════════════"

  deploy-to-digital-ocean:
    docker:
      - image: cimg/base:current

    resource_class: small

    steps:
      - checkout

      # Install doctl
      - run:
          name: "Install doctl"
          command: |
            cd ~
            wget https://github.com/digitalocean/doctl/releases/download/v1.104.0/doctl-1.104.0-linux-amd64.tar.gz
            tar xf doctl-1.104.0-linux-amd64.tar.gz
            sudo mv doctl /usr/local/bin
            doctl version

      # Authenticate with Digital Ocean
      - run:
          name: "Authenticate with Digital Ocean"
          command: |
            echo "Authenticating with Digital Ocean for deployment..."
            echo "Branch: ${CIRCLE_BRANCH}"

            if [ -z "$DO_ACCESS_TOKEN" ]; then
              echo "ERROR: DO_ACCESS_TOKEN environment variable is not set!"
              echo "Please add it to CircleCI Project Settings → Environment Variables"
              exit 1
            fi

            # Verify token is present (show first/last 4 chars only for security)
            TOKEN_LENGTH=${#DO_ACCESS_TOKEN}
            TOKEN_PREFIX=${DO_ACCESS_TOKEN:0:4}
            TOKEN_SUFFIX=${DO_ACCESS_TOKEN: -4}
            echo "Using DO_ACCESS_TOKEN from CircleCI (length: $TOKEN_LENGTH, starts: $TOKEN_PREFIX..., ends: ...$TOKEN_SUFFIX)"

            doctl auth init --access-token ${DO_ACCESS_TOKEN}

            # Verify authentication and check account info
            echo "Verifying authentication..."
            doctl account get

            echo "✓ Successfully authenticated with Digital Ocean"

      # Deploy to Digital Ocean App Platform
      - run:
          name: "Deploy to Digital Ocean App Platform"
          command: |
            echo "═══════════════════════════════════════════════════════"
            echo "Digital Ocean Deployment - Dev Branch"
            echo "═══════════════════════════════════════════════════════"

            if [ -z "$DO_APP_ID" ]; then
              echo "ERROR: DO_APP_ID environment variable is not set!"
              echo ""
              echo "To fix this:"
              echo "1. Go to https://cloud.digitalocean.com/apps"
              echo "2. Create an app or get your existing app ID"
              echo "3. Add DO_APP_ID to CircleCI:"
              echo "   Project Settings → Environment Variables → Add Variable"
              echo ""
              exit 1
            fi

            if [ -z "$DO_REGISTRY_NAME" ]; then
              echo "ERROR: DO_REGISTRY_NAME is not set (should be 'migratingassistant')"
              exit 1
            fi

            # Verify doctl is still authenticated
            echo "Verifying doctl authentication..."
            doctl account get || {
              echo "ERROR: doctl authentication lost between steps"
              echo "Re-authenticating..."
              doctl auth init --access-token ${DO_ACCESS_TOKEN}
            }

            # Verify we can access the app
            echo "Verifying access to app ${DO_APP_ID}..."
            doctl apps get ${DO_APP_ID} > /dev/null 2>&1 || {
              echo "ERROR: Cannot access app ${DO_APP_ID}"
              echo "This could mean:"
              echo "1. The app doesn't exist"
              echo "2. The DO_ACCESS_TOKEN doesn't have permission to access this app"
              echo "3. The app is in a different DigitalOcean account/team"
              echo ""
              echo "Checking accessible apps..."
              doctl apps list
              exit 1
            }

            # Display deployment info
            REGISTRY_NAME="${DO_REGISTRY_NAME}"
            REGISTRY_URL="registry.digitalocean.com/${REGISTRY_NAME}"
            IMAGE_TAG="${CIRCLE_SHA1}"

            echo ""
            echo "Deployment Configuration:"
            echo "  Environment: dev"
            echo "  App ID: ${DO_APP_ID}"
            echo "  Registry: ${REGISTRY_URL}"
            echo "  Image: migratingassistant-api:${IMAGE_TAG}"
            echo "  Branch: ${CIRCLE_BRANCH}"
            echo ""

            echo "Deploying image: ${REGISTRY_URL}/migratingassistant-api:${IMAGE_TAG}"
            echo ""

            # Trigger deployment
            echo "Triggering deployment (this may take 2-5 minutes)..."
            doctl apps create-deployment ${DO_APP_ID} --wait

            echo ""
            echo "✓ Deployment completed successfully!"
            echo ""
            echo "═══════════════════════════════════════════════════════"
            echo "Deployment Summary - DEV"
            echo "═══════════════════════════════════════════════════════"
            echo "Image: ${REGISTRY_URL}/migratingassistant-api:${IMAGE_TAG}"
            echo "App: https://cloud.digitalocean.com/apps/${DO_APP_ID}"
            echo ""
            echo "View logs:"
            echo "  doctl apps logs ${DO_APP_ID} --type=run --follow"
            echo "═══════════════════════════════════════════════════════"

      # Alternative: Deploy to Droplet via SSH (commented out)
      # Uncomment if deploying to a droplet instead of App Platform
      # - add_ssh_keys:
      #     fingerprints:
      #       - "YOUR_SSH_KEY_FINGERPRINT"
      #
      # - run:
      #     name: "Deploy to Digital Ocean Droplet"
      #     command: |
      #       ssh -o StrictHostKeyChecking=no ${DO_DROPLET_USER}@${DO_DROPLET_IP} << 'EOF'
      #         cd /opt/migratingassistant
      #
      #         # Pull latest image
      #         doctl registry login
      #         docker pull registry.digitalocean.com/${DO_REGISTRY_NAME}/migratingassistant-api:${CIRCLE_SHA1}
      #
      #         # Stop and remove old container
      #         docker-compose down
      #
      #         # Update docker-compose.yml to use new image tag
      #         sed -i "s|image: .*|image: registry.digitalocean.com/${DO_REGISTRY_NAME}/migratingassistant-api:${CIRCLE_SHA1}|g" docker-compose.yml
      #
      #         # Start new container
      #         docker-compose up -d
      #
      #         # Show status
      #         docker-compose ps
      #       EOF

# Define workflows
workflows:
  build-test-deploy:
    jobs:
      # Build and test on all branches
      - build-and-test

      # Publish artifacts on dev branch only
      - publish-artifacts:
          requires:
            - build-and-test
          filters:
            branches:
              only:
                - dev

      # Build and push Docker image on dev branch only
      - build-and-push-docker:
          requires:
            - build-and-test
          filters:
            branches:
              only:
                - dev

      # Deploy to dev branch only
      - deploy-to-digital-ocean:
          requires:
            - build-and-push-docker
          filters:
            branches:
              only:
                - dev